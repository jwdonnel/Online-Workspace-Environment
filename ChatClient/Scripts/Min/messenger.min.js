function getParameterByName(e) { e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]"); var t = "[\\?&]" + e + "=([^&#]*)", a = new RegExp(t), s = a.exec(window.location.search); return null == s ? "" : decodeURIComponent(s[1].replace(/\+/g, " ")) } function FindAndCreateEmoticons() { $.ajax({ type: "POST", url: pageUrl + "/GetEmoticons", data: "{ }", contentType: "application/json; charset=utf-8", dataType: "json", success: function (e) { if ($("#emoticons-holder").html(""), e.d.length > 0) for (var t = 0; t < e.d.length; t++) { var a = e.d[t]; a = a.substring(a.lastIndexOf("/") + 1), a = a.replace(a.substring(a.indexOf(".")), ""), $("#emoticons-holder").append("<img alt='{" + t + "}' src='" + e.d[t] + "' title='" + a + "' />") } } }) } function ChatBoxKeyDown(e) { try { if (13 == e.which) return postChatMessage(), _isTyping = !1, $("#chatEnterMessage").focus(), !1; 0 == _isTyping && (isTyping("1"), _isTyping = !0) } catch (t) { if (13 == e.keyCode) return postChatMessage(), _isTyping = !1, $("#chatEnterMessage").focus(), !1; 0 == _isTyping && (isTyping("1"), _isTyping = !0), delete t } } function ChatBoxFocus() { "Type message here..." != $.trim($("#chatEnterMessage").val()) && "" != $.trim($("#chatEnterMessage").val()) || $("#chatEnterMessage").is(":disabled") || 0 != _isTyping || ($("#chatEnterMessage").val(""), 0 == loadingposts && isTyping("0")) } function ChatBoxBlur() { isTyping("0"), _isTyping = !1, "" == $.trim($("#chatEnterMessage").val()) && $("#chatEnterMessage").val("Type message here...") } function ViewEmoticons() { if ($("#addImage-overlay").hide(), $this = $("#emoticon-overlay"), "block" != $this.css("display")) { $this.show(); var e = -($this.height() / 2); $this.css({ marginTop: e }) } else $this.hide() } function ViewAddImage() { if ($("#emoticon-overlay").hide(), $this = $("#addImage-overlay"), $this.find("#tb_addImage").val("Image Url"), "block" != $this.css("display")) { $this.show(), $("#tb_addImage").focus(); var e = -($this.height() / 2); $this.css({ marginTop: e }) } else $this.hide() } function AddImage() { var e = document.getElementById("chatEnterMessage"); if (!e.disabled) { var t = $.trim($("#tb_addImage").val()); checkURL(t) ? "Image Url" != t && "" != t && (e.value = "<img alt='' src='" + t + "' class='chat-message-image' />", $("#addImage-overlay").hide(), postChatMessage()) : ($("#image-error-msg").html("<span style='color: Red;'>Not an image!</span>"), setTimeout(function () { $("#image-error-msg").html("") }, 2500)) } } function checkURL(e) { return null != e.match(/\.(jpeg|jpg|gif|png)$/) } function AddImageKeyPress() { try { if (13 == event.which) return AddImage(), !1 } catch (e) { if (13 == event.keyCode) return AddImage(), !1; delete e } } function GetEmoticon(e) { return $(".emoticons img").each(function () { for (var t = $(this), a = t.attr("src"), s = t.attr("alt") ; -1 != e.indexOf(s) ;) e = e.replace(s, "<img alt='' src='" + a + "' />") }), e } function isTyping(e) { _isTypingCall || (_isTypingCall = !0, $.ajax({ type: "POST", url: pageUrl + "/CallIsTyping", data: '{ "typing": "' + e + '","userto": "' + currUser + '" }', contentType: "application/json; charset=utf-8", dataType: "json", complete: function () { _isTypingCall = !1 } })) } function postChatMessage() { var e = document.getElementById("chatEnterMessage"); if ("Type message here..." == e.value || "" == e.value) e.disabled = !1; else if (!_isAddCall) { _isAddCall = !0, $("#emoticon-overlay").hide(), $("#addImage-overlay").hide(), $("#chatmessages").append("<div id='chatloading_img'>Please wait...</div>"); var t = document.getElementById("chatmessages"); t.scrollTop = t.scrollHeight, e.disabled = !0, $.ajax({ type: "POST", url: pageUrl + "/CallAddMessage", data: '{ "message": "' + escape(e.value) + '","userto": "' + currUser + '" }', contentType: "application/json; charset=utf-8", success: function (t) { if (null != t.d[0]) { e.value = ""; var a = $.trim($("#chatmessages").html()); a = a.replace(/"/gi, "'"); var s = "<div class='chatLineSep-noposts'>No posts available</div>"; a == s && $("#chatmessages").html(""), updateMessages(t.d), _isTyping = !1, e.focus(), e.disabled = !1 } _isAddCall = !1 }, error: function () { e.value = ""; var t = $.trim($("#chatmessages").html()); t = t.replace(/"/gi, "'"); var a = "<div class='chatLineSep-noposts'>No posts available</div>"; t == a && $("#chatmessages").html(""), _isTyping = !1, e.focus(), e.disabled = !1, _isAddCall = !1 } }) } } function LoadFontStyles() { $.ajax({ type: "POST", url: pageUrl + "/LoadFontStyle", data: "{ }", contentType: "application/json; charset=utf-8", dataType: "json", cache: !1, success: function (e) { 3 == e.d.length && (LoadCustomFontFamily(e.d[0]), LoadCustomFontSize(e.d[1]), LoadCustomFontColor(e.d[2])) } }) } function LoadCustomFontFamily(e) { if (null != e && "" != e) { $("link[href='" + e + "']").remove(); var t = document.getElementsByTagName("head")[0]; link = document.createElement("link"), link.type = "text/css", link.rel = "stylesheet", link.href = e, t.appendChild(link) } } function LoadCustomFontSize(e) { null != e && "" != e && $("body").css("font-size", e) } function LoadCustomFontColor(e) { null != e && "" != e && $("body").css("color", e) } function updateChatMessages() { _isUpdateCall || (_isUpdateCall = !0, $.ajax({ type: "POST", url: pageUrl + "/CallMessages", data: '{ "userto": "' + currUser + '","isPostBack": "' + isPostBack + '" }', contentType: "application/json; charset=utf-8", dataType: "json", cache: !1, success: function (e) { null != e.d[0] && updateMessages(e.d[0]), _isUpdateCall = !1, updateChatMessages() }, error: function () { _isUpdateCall = !1, updateChatMessages() } })) } function updateMessages(e) { setChatMessages(e[1]), setIsTyping(e[2]), setOnlineStatus(e[0]) } function setChatMessages(e) { 1 == loadingposts && $.trim(e) != $.trim($("#chatmessages").text()) && ($("#chatmessages").html(""), loadingposts = 0); var t; if ("" != e && null != e && 1 == isPostBack) { $("#chatmessages").hide(), $("#chatmessages").html(GetEmoticon(e)); for (var a = new Array, s = $(".chatLineSep").size() - 1; s >= 0; s--) if ($(".chatLineSep").eq(s).hasClass("continued-chat")) a.push("<div class='clear-space-five'></div>" + $(".chatLineSep").eq(s).html()), $(".chatLineSep").eq(s).remove(); else { for (var i = a.length - 1; i >= 0; i--) $(".chatLineSep").eq(s).find(".smsg-text").append(a[i]); a = new Array } $("#chatmessages").show(), t = document.getElementById("chatmessages"), t.scrollTop = t.scrollHeight, AdjustScroll() } if ("" != e && null != e && 0 == isPostBack) { $("#chatloading_img").remove(), "no posts available" == $("#chatmessages").find(".chatLineSep-noposts").text().toLowerCase() && $("#chatmessages").html(""); var n = $(".chatLineSep"), o = $.makeArray(n), l = $(".chatLineSep").size() - 1, c = $(o).eq(l).find(".date-nodisplay").attr("id"), r = $(e).find("#" + c); if (0 == r.length) { if ($("#chatmessages").append(GetEmoticon(e)), $(".chatLineSep").last().hasClass("continued-chat")) { var d = $(".chatLineSep").last().html(); $(".chatLineSep").last().remove(); for (var s = $(".chatLineSep").size() - 1; s >= 0; s--) if (!$(".chatLineSep").eq(s).hasClass("continued-chat")) { $(".chatLineSep").eq(s).find(".smsg-text").append("<div class='clear-space-five'></div>" + d); break } } t = document.getElementById("chatmessages"), t.scrollTop = t.scrollHeight, AdjustScroll() } } 1 == isPostBack && (isPostBack = 0), AdjustTimeZone() } function AdjustScroll() { $("img").load(function () { elem = document.getElementById("chatmessages"), elem.scrollTop = elem.scrollHeight }) } function AdjustTimeZone() { $(".date-chat-line").each(function () { if (!$(this).hasClass("time-adjusted")) try { if ($(this).html().split(";").length > 1) { var e = new Date, t = $(this).html().split(";")[0], a = $(this).html().split(";")[1], s = t.match(/(\d+)\:(\d+) (\w+)/), i = /am/i.test(s[3]) ? parseInt(s[1], 10) : parseInt(s[1], 10) + 12, n = parseInt(s[2], 10), o = e.getTimezoneOffset(); o = -1 * (o / 60 * -1 - parseInt(a)), i -= o, e.setHours(i), e.setMinutes(n); var l = e.toLocaleTimeString().split(":"), c = l[2].split(" ")[1]; $(this).html(l[0] + ":" + l[1] + " " + c), $(this).addClass("time-adjusted") } } catch (r) { } }) } function setOnlineStatus(e) { var t = document.getElementById("chatEnterMessage"); "offline" == e ? (t.disabled = !0, $("#userStatusMessage").html("<div>User is offline</div>"), $("#chatEnterMessage").val("")) : "online" == e && (0 != t.disabled || 1 == isLoadingModal) && (t.disabled = !1, $("#userStatusMessage").html(""), $("#chatEnterMessage").val(1 == isLoadingModal ? "" : "Type message here..."), $("#chatEnterMessage").focus()), isLoadingModal = 0 } function setIsTyping(e) { $("#userStatusMessage").html("istyping" == e ? "<div>" + currUser + " is typing...</div>" : "") } var pageUrl = "../ChatClient/ChatService.asmx", currUser = "", loadingtag = "<h3 class='float-left' style='padding-top: 7px; padding-left: 5px;'>Loading posts. Please wait...</h3>", loadingposts = 0, isPostBack = 1, isLoadingModal = 1; $(document).ready(function () { Array.prototype.indexOf, Array.prototype.indexOf || (Array.prototype.indexOf = function (e, t) { for (var a = t || 0, s = this.length; s > a; a++) if (this[a] === e) return a; return -1 }), LoadFontStyles(), currUser = getParameterByName("user"), $("#chatmessages").html(loadingtag), loadingposts = 1, updateChatMessages(), FindAndCreateEmoticons(), document.title = currUser + " - Chat Client" }); var _isTyping = !1; $(document.body).on("focus", "#chatEnterMessage", function () { ChatBoxFocus() }), $(document.body).on("blur", "#chatEnterMessage", function () { ChatBoxBlur() }), $(document.body).on("click", ".emoticons img", function () { var e = document.getElementById("chatEnterMessage"); if (!e.disabled) { var t = $(this).attr("alt"); "Type message here..." == e.value && (e.value = ""), e.value += t + " ", e.focus() } }); var _isTypingCall = !1, _isAddCall = !1, _isUpdateCall = !1;